# KernelSeal Sidecar Deployment Template
# This shows how to deploy KernelSeal as a sidecar alongside your application
---
apiVersion: v1
kind: ConfigMap
metadata:
  name: kernelseal-config
  namespace: default
data:
  config.yaml: |
    version: v1
    policy:
      mode: enforce          # disabled, audit, or enforce
      blockEnviron: true     # Block /proc/*/environ reads
      blockMem: true         # Block /proc/*/mem reads  
      blockMaps: false       # Block /proc/*/maps reads
      blockPtrace: true      # Block ptrace to protected processes
      allowSelfRead: true    # Allow process to read its own /proc files
      auditAll: false        # Audit all accesses, not just blocked ones
    
    secrets:
      - name: myapp-secrets
        selector:
          binary: "myapp"    # Inject into processes named "myapp"
        secretRefs:
          - name: DATABASE_PASSWORD
            source:
              secretKeyRef:
                name: myapp-db-credentials
                key: password
          - name: API_KEY
            source:
              secretKeyRef:
                name: myapp-api-key
                key: api-key
    
    monitoring:
      enabled: true
      metricsPort: 9090
      logLevel: info
      auditLog: /var/log/kernelseal/audit.log
---
apiVersion: v1
kind: Pod
metadata:
  name: kernelseal-demo
  labels:
    app: kernelseal-demo
    kernelseal.io/protected: "true"
spec:
  shareProcessNamespace: true  # Required for KernelSeal to access app processes
  
  containers:
  # Your application container
  - name: myapp
    image: alpine:latest
    command: ["sh", "-c", "echo 'App starting'; sleep 3600"]
    resources:
      requests:
        memory: "64Mi"
        cpu: "100m"
      limits:
        memory: "128Mi"
        cpu: "200m"
    # No secrets mounted here - KernelSeal injects them at runtime
    volumeMounts:
    - name: kernelseal-secrets-runtime
      mountPath: /run/kernelseal/secrets
      readOnly: true

  # KernelSeal sidecar container
  - name: kernelseal
    image: your-registry/kernelseal:latest
    args:
      - "-config=/etc/kernelseal/config.yaml"
    securityContext:
      privileged: true
      capabilities:
        add:
          - SYS_ADMIN      # Required for BPF
          - BPF            # Required for BPF
          - SYS_PTRACE     # Required for process memory access
          - PERFMON        # Required for perf events
    resources:
      requests:
        memory: "64Mi"
        cpu: "50m"
      limits:
        memory: "256Mi"
        cpu: "500m"
    volumeMounts:
    - name: kernelseal-config
      mountPath: /etc/kernelseal
      readOnly: true
    - name: kernelseal-secrets-runtime
      mountPath: /run/kernelseal/secrets
    - name: kernelseal-secrets-source
      mountPath: /var/run/secrets/kernelseal
      readOnly: true
    - name: sys-kernel-debug
      mountPath: /sys/kernel/debug
      readOnly: true
    - name: sys-kernel-btf
      mountPath: /sys/kernel/btf
      readOnly: true
    - name: bpf-maps
      mountPath: /sys/fs/bpf

  volumes:
  - name: kernelseal-config
    configMap:
      name: kernelseal-config
  - name: kernelseal-secrets-runtime
    emptyDir:
      medium: Memory
      sizeLimit: 10Mi
  - name: kernelseal-secrets-source
    projected:
      sources:
      - secret:
          name: myapp-db-credentials
          items:
          - key: password
            path: myapp-db-credentials/password
      - secret:
          name: myapp-api-key
          items:
          - key: api-key
            path: myapp-api-key/api-key
  - name: sys-kernel-debug
    hostPath:
      path: /sys/kernel/debug
      type: Directory
  - name: sys-kernel-btf
    hostPath:
      path: /sys/kernel/btf
      type: DirectoryOrCreate
  - name: bpf-maps
    hostPath:
      path: /sys/fs/bpf
      type: DirectoryOrCreate
