# KernelSeal Demo with Docker
# This demonstrates KernelSeal monitoring a container and injecting secrets

version: '3.8'

services:
  # KernelSeal Sidecar - runs privileged to load BPF programs
  kernelseal:
    build:
      context: ..
      dockerfile: demo/Dockerfile.kernelseal
    privileged: true
    pid: "host"  # Share PID namespace to monitor other containers
    volumes:
      - /sys/kernel/debug:/sys/kernel/debug:ro
      - /sys/fs/bpf:/sys/fs/bpf
      - ../examples/demo-config.yaml:/etc/kernelseal/config.yaml:ro
    environment:
      - KernelSeal_DEMO_API_KEY=docker-demo-api-key-12345
      - KernelSeal_DEMO_DB_PASSWORD=docker-demo-password
      - KernelSeal_DEMO_SECRET=docker-demo-secret
    cap_add:
      - SYS_ADMIN
      - BPF
      - SYS_PTRACE
      - NET_ADMIN
    networks:
      - kernelseal-demo

  # Demo application that KernelSeal will monitor
  demo-app:
    build:
      context: ..
      dockerfile: demo/Dockerfile.demo-app
    depends_on:
      - kernelseal
    networks:
      - kernelseal-demo
    # This container will have secrets injected by KernelSeal
    command: ["sh", "-c", "echo 'Demo app running...'; while true; do echo 'Tick'; sleep 5; done"]

networks:
  kernelseal-demo:
    driver: bridge
