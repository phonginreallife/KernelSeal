# KernelSeal Configuration
# Copy this file to /etc/kernelseal/config.yaml and customize

version: v1

policy:
  # Enforcement mode:
  # - disabled: KernelSeal does nothing
  # - audit: Log accesses but don't block
  # - enforce: Log and block unauthorized access
  mode: enforce
  
  # Protect environment variables from being read via /proc/<pid>/environ
  blockEnviron: true
  
  # Protect process memory from being read via /proc/<pid>/mem
  blockMem: true
  
  # Protect memory maps from being read via /proc/<pid>/maps
  # Note: Some debugging tools need this, set to false if needed
  blockMaps: false
  
  # Prevent ptrace from attaching to protected processes
  blockPtrace: true
  
  # Allow a process to read its own /proc files
  # This is usually safe and needed for self-inspection
  allowSelfRead: true
  
  # Log all accesses (even allowed ones) for audit purposes
  auditAll: false
  
  # Kernel-side binary filtering (RECOMMENDED for production)
  # When enabled, KernelSeal only monitors processes matching configured binaries
  # This significantly reduces CPU overhead on busy systems
  # When disabled, KernelSeal monitors ALL process executions (higher overhead)
  kernelBinaryFilter: true

secrets:
  # ------------------------------------------------------
  # WORKING: Environment variable source (envRef)
  # ------------------------------------------------------
  
  # Example: Inject secrets into sleep command (for testing)
  - name: test-secrets
    selector:
      binary: "sleep"
    secretRefs:
      - name: MY_SECRET
        source:
          envRef: MY_SECRET_VALUE        # Reads from $MY_SECRET_VALUE env var
      - name: DB_PASSWORD
        source:
          envRef: DB_PASSWORD_VALUE      # Reads from $DB_PASSWORD_VALUE env var

  # Example: Inject AWS credentials into AWS CLI
  - name: aws-secrets
    selector:
      binary: "aws"
    secretRefs:
      - name: AWS_ACCESS_KEY_ID
        source:
          envRef: AWS_ACCESS_KEY_ID_VALUE
      - name: AWS_SECRET_ACCESS_KEY
        source:
          envRef: AWS_SECRET_ACCESS_KEY_VALUE

  # ------------------------------------------------------
  # WORKING: File source (fileRef)
  # ------------------------------------------------------
  
  # Example: Read secrets from files (Vault agent sidecar integration)
  - name: webapp-secrets
    selector:
      binary: "node"
    secretRefs:
      - name: JWT_SECRET
        source:
          fileRef: "/vault/secrets/jwt-secret"
      - name: API_KEY
        source:
          fileRef: "/run/secrets/api-key"

  # ------------------------------------------------------
  # PLANNED: Kubernetes secret source (secretKeyRef)
  # Requires Kubernetes API access - not yet implemented
  # ------------------------------------------------------
  
  # - name: postgres-secrets
  #   selector:
  #     binary: "psql"
  #   secretRefs:
  #     - name: PGPASSWORD
  #       source:
  #         secretKeyRef:
  #           name: postgres-credentials
  #           namespace: default
  #           key: password

  # ------------------------------------------------------
  # PLANNED: HashiCorp Vault source (vaultRef)
  # Requires Vault integration - not yet implemented
  # ------------------------------------------------------
  
  # - name: vault-secrets
  #   selector:
  #     binary: "myapp"
  #   secretRefs:
  #     - name: DB_PASSWORD
  #       source:
  #         vaultRef:
  #           path: "secret/data/myapp/db"
  #           key: "password"

monitoring:
  enabled: true
  metricsPort: 9090
  logLevel: info  # debug, info, warn, error
  auditLog: /var/log/kernelseal/audit.log

# ------------------------------------------------------
# Quick Start Example
# ------------------------------------------------------
# 
# 1. Create config with environment variable secrets:
#
#    cat > /etc/kernelseal/config.yaml << 'EOF'
#    version: v1
#    policy:
#      mode: enforce
#      blockEnviron: true
#      blockMem: true
#      blockPtrace: true
#      kernelBinaryFilter: true
#    secrets:
#      - name: test
#        selector:
#          binary: "sleep"
#        secretRefs:
#          - name: SECRET_KEY
#            source:
#              envRef: SECRET_KEY_VALUE
#    EOF
#
# 2. Run KernelSeal with the secret value:
#
#    export SECRET_KEY_VALUE="my-secret-123"
#    kernelseal -config /etc/kernelseal/config.yaml
#
# 3. Test protection:
#
#    sleep 300 &
#    cat /proc/$!/environ  # Should be blocked!
