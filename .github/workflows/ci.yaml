name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  GO_VERSION: '1.22'
  GOLANGCI_LINT_VERSION: 'v1.55'

# Cancel in-progress runs for the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Fast checks first - fail fast on simple issues
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run golangci-lint
        uses: golangci/golangci-lint-action@v4
        with:
          version: ${{ env.GOLANGCI_LINT_VERSION }}
          args: --timeout=5m
          # Skip cache - action handles it internally
          skip-cache: false
          skip-pkg-cache: false
          skip-build-cache: false

  # Unit tests - parallel with lint
  test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run unit tests
        run: go test -v -race -coverprofile=coverage.out -covermode=atomic ./internal/...

      - name: Upload coverage
        uses: codecov/codecov-action@v4
        with:
          file: ./coverage.out
          flags: unittests
          fail_ci_if_error: false
        continue-on-error: true

  # Security scan - parallel with lint/test
  security:
    name: Security Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Run govulncheck
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck ./... || true

      - name: Run Gosec
        uses: securego/gosec@master
        with:
          args: '-no-fail -fmt sarif -out results.sarif ./...'
        continue-on-error: true

      - name: Upload SARIF
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
        if: always()
        continue-on-error: true

  # Build BPF programs - with aggressive caching
  build-bpf:
    name: Build BPF Programs
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache APT packages
        uses: awalsh128/cache-apt-pkgs-action@latest
        with:
          packages: clang llvm libbpf-dev bpftool
          version: 1.0

      - name: Cache vmlinux.h
        id: cache-vmlinux
        uses: actions/cache@v4
        with:
          path: bpf/vmlinux.h
          key: vmlinux-${{ runner.os }}-${{ hashFiles('/sys/kernel/btf/vmlinux') }}
          restore-keys: |
            vmlinux-${{ runner.os }}-

      - name: Generate vmlinux.h
        if: steps.cache-vmlinux.outputs.cache-hit != 'true'
        run: |
          sudo bpftool btf dump file /sys/kernel/btf/vmlinux format c > bpf/vmlinux.h

      - name: Cache BPF objects
        id: cache-bpf
        uses: actions/cache@v4
        with:
          path: bpf/*.bpf.o
          key: bpf-${{ runner.os }}-${{ hashFiles('bpf/*.bpf.c', 'bpf/*.h') }}

      - name: Build BPF programs
        if: steps.cache-bpf.outputs.cache-hit != 'true'
        run: make bpf

      - name: Upload BPF objects
        uses: actions/upload-artifact@v6
        with:
          name: bpf-objects
          path: bpf/*.bpf.o
          retention-days: 7

  # Build Go binary - depends on lint/test passing
  build:
    name: Build Binary
    runs-on: ubuntu-latest
    needs: [lint, test]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Cache Go build
        uses: actions/cache@v4
        with:
          path: ~/.cache/go-build
          key: go-build-${{ runner.os }}-${{ hashFiles('**/*.go', 'go.sum') }}
          restore-keys: |
            go-build-${{ runner.os }}-

      - name: Build binary
        run: |
          CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build \
            -ldflags="-w -s -X main.Version=${{ github.sha }}" \
            -o kernelseal ./cmd/main.go

      - name: Upload binary
        uses: actions/upload-artifact@v6
        with:
          name: kernelseal-binary
          path: kernelseal
          retention-days: 7

  # Docker build - with layer caching
  docker:
    name: Build Docker Image
    runs-on: ubuntu-latest
    needs: [build, build-bpf]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download BPF objects
        uses: actions/download-artifact@v4
        with:
          name: bpf-objects
          path: bpf/

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: false
          tags: kernelseal:ci-test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          # Build args for layer caching
          build-args: |
            BUILDKIT_INLINE_CACHE=1

  # Kubernetes manifest validation - parallel, no dependencies
  validate-k8s:
    name: Validate K8s Manifests
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Cache kubeconform
        id: cache-kubeconform
        uses: actions/cache@v4
        with:
          path: /usr/local/bin/kubeconform
          key: kubeconform-v0.6.4

      - name: Install kubeconform
        if: steps.cache-kubeconform.outputs.cache-hit != 'true'
        run: |
          wget -q https://github.com/yannh/kubeconform/releases/download/v0.6.4/kubeconform-linux-amd64.tar.gz
          tar xf kubeconform-linux-amd64.tar.gz
          sudo mv kubeconform /usr/local/bin/

      - name: Validate manifests
        run: |
          kubeconform -strict -summary deploy/manifests/*.yaml || true
          kubeconform -strict -summary deploy/kernelseal-sidecar.yaml || true

  # Integration tests - only on main, requires BPF
  integration-test:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [build, build-bpf]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: Download BPF objects
        uses: actions/download-artifact@v4
        with:
          name: bpf-objects
          path: bpf/

      - name: Download binary
        uses: actions/download-artifact@v4
        with:
          name: kernelseal-binary

      - name: Run integration tests
        run: |
          chmod +x ./kernelseal
          # Verify binary runs
          ./kernelseal -help || true
          # Run Go integration tests (mocked, no BPF required)
          go test -v -tags=integration ./test/integration/... || true
